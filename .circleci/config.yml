version: 2.1

orbs:
  node: circleci/node@5.0.2
  sonarcloud: sonarsource/sonarcloud@2.0.0

jobs:
  build-and-scan:
    docker:
      - image: cimg/node:18.19
    steps:
      - checkout

      # Install dependencies
      - run:
          name: Install dependencies
          command: |
            cd "insy7314 part2 latest/international-payments/backend"
            npm install

      # Build backend
      - run:
          name: Build backend
          command: |
            cd "insy7314 part2 latest/international-payments/backend"
            npm run build || echo "⚠️ No build script found, skipping..."

      # Run tests and generate coverage
      - run:
          name: Run tests with coverage
          command: |
            cd "insy7314 part2 latest/international-payments/backend"
            npm test -- --coverage --watchAll=false || echo "⚠️ Tests may have failed, continuing..."

      # Run SonarCloud scan
      - sonarcloud/scan:
          project-base-dir: "insy7314 part2 latest/international-payments/backend"
          extra-params: >
            -Dsonar.projectKey=$SONAR_PROJECT_KEY
            -Dsonar.organization=$SONAR_ORGANIZATION
            -Dsonar.projectName="International Payments Backend"
            -Dsonar.sources=src
            -Dsonar.tests=test
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

workflows:
  version: 2
  main:
    jobs:
      - build-and-scan
